/*! mica-study-timeline - v1.0.0-SNAPSHOT
 *  License: GNU Public License version 3
 *  Date: 2014-05-02
 */
!function(){"use strict";d3.timeline=function(){function a(a){function b(a){return n.left+(a.starting_time-l)*B}function i(a){return(a.ending_time-a.starting_time)*B}function j(){if(g||w.attr("height"))g?w.attr("height",g):g=w.attr("height");else{if(!q)throw"height of the timeline is not set";g=G.height+G.top-v.top,d3.select(a[0][0]).attr("height",g)}}function s(){if(!f&&!v.width)throw"width of the timeline is not set";f&&v.width||(f?w.attr("width",f):f=w.attr("width"))}function t(a,b,c,d,e){return"M"+a+","+b+"h"+(c-e)+"a"+e+","+e+" 0 0 1 "+e+","+e+"v"+(d-2*e)+"a"+e+","+e+" 0 0 1 "+-e+","+e+"h"+(e-c)+"z"}var u=a.append("g"),v=a[0][0].getBoundingClientRect(),w=d3.select(a[0][0]),x={},y=1,z=0,A=0;s(),(o||0===m&&0===l)&&(u.each(function(a){a.forEach(function(a,b){o&&-1==Object.keys(x).indexOf(b)&&(x[b]=y,y++),0===m&&0===l&&a.events.forEach(function(a){(a.starting_time<z||0===z)&&(z=a.starting_time),a.ending_time>A&&(A=a.ending_time)})})}),0===m&&0===l&&(l=z,m=A));var B=1/(m-l)*(f-n.left-n.right),C=h.format,D=function(a){return k+parseInt(C(a),null)/12},E=d3.time.scale().domain([l,m]).range([n.left,f-n.right]),F=d3.svg.axis().scale(E).orient(e).tickFormat(D).tickSubdivide(1).tickValues(d3.range(l,m+1,12)).tickSize(h.tickSize,h.tickSize/2,0);u.append("g").attr("class","axis").attr("transform","translate(0,"+(n.top+(q+r)*y)+")").call(F),u.each(function(e){e.forEach(function(e,f){function g(){return o?n.top+(q+r)*x[f]:n.top}var h=e.population.events,j="undefined"!=typeof e.label;u.selectAll("svg").data(h).enter().append("path").attr("d",function(a,c){var d=b(a,c),e=g(a,c),f=i(a,c);return t(d,e,f,q,5)}).style("fill",e.population.color).on("mouseover",function(a){c(a,f,e)}).on("click",function(a){d(a,f,e)}).append("title").text(function(a){return a.title}),j&&a.append("text").attr("class","timeline-label").attr("transform","translate(0,"+(q/2+n.top+(q+r)*x[f])+")").text(j?e.label:e.id),"undefined"!=typeof e.icon&&a.append("image").attr("class","timeline-label").attr("transform","translate(0,"+(n.top+(q+r)*x[f])+")").attr("xlink:href",e.icon).attr("width",n.left).attr("height",q)})}),p&&u.selectAll("text").attr("transform",function(){return"rotate("+p+")translate("+(this.getBBox().width/2+10)+","+this.getBBox().height/2+")"});var G=u[0][0].getBoundingClientRect();j()}var b=["circle","rect"],c=function(){},d=function(){},e="bottom",f=null,g=null,h={format:d3.format("d"),tickTime:1,tickNumber:1,tickSize:10},i=d3.scale.category20(),j="rect",k=0,l=0,m=0,n={left:30,right:30,top:30,bottom:30},o=!1,p=!1,q=10,r=5;return a.margin=function(b){return arguments.length?(n=b,a):n},a.orient=function(b){return arguments.length?(e=b,a):e},a.itemHeight=function(b){return arguments.length?(q=b,a):q},a.itemMargin=function(b){return arguments.length?(r=b,a):r},a.height=function(b){return arguments.length?(g=b,a):g},a.width=function(b){return arguments.length?(f=b,a):f},a.display=function(c){return arguments.length&&-1!=b.indexOf(c)?(j=c,a):j},a.tickFormat=function(b){return arguments.length?(h=b,a):h},a.hover=function(b){return arguments.length?(c=b,a):c},a.click=function(b){return arguments.length?(d=b,a):d},a.colors=function(b){return arguments.length?(i=b,a):i},a.startYear=function(b){return arguments.length?(k=b,a):k},a.beginning=function(b){return arguments.length?(l=b,a):l},a.ending=function(b){return arguments.length?(m=b,a):m},a.rotateTicks=function(b){return p=b,a},a.stack=function(){return o=!o,a},a}}(),function(a){"use strict";function b(a){var b={min:Number.MAX_VALUE,max:Number.MIN_VALUE},d=c(a,b);if(0===d.length)return null;var e={start:(b.min-1)/12,min:0,max:b.max-b.min,data:d};return console.log("RESULT:",e),e}function c(b,c){function d(a,b,c){b.hasOwnProperty(c)&&(a[c]=b[c])}function e(a,b,c){b.hasOwnProperty(c)&&(a[c]=b[c][0].value)}function f(b,c,f){function g(a,b,c){var d=b.hasOwnProperty("startYear")?b.startYear:0,e=b.hasOwnProperty("startMonth")?b.startMonth:1;a.starting_time=i(d,d>0?e:0),c.min>a.starting_time&&(c.min=a.starting_time)}function h(a,b,c){var d=b.hasOwnProperty("endYear")?b.endYear:0,e=b.hasOwnProperty("endMonth")?b.endMonth:12;a.ending_time=i(d,d>0?e:0),c.max<a.ending_time&&(c.max=a.ending_time)}function i(a,b){return console.log("y",a,"m",b,"=",12*parseInt(a,10)+parseInt(b,10)),12*parseInt(a,10)+parseInt(b,10)}if(!jQuery.isEmptyObject(c)){var j=[];a.each(c,function(a,b){var c={};d(c,b,"id"),e(c,b,"name"),g(c,b,f),h(c,b,f),jQuery.isEmptyObject(c)||j.push(c)}),j.length>0&&(b.events=j)}}if(null!==b&&b.hasOwnProperty("populations")){var g,h=[];return a.each(b.populations,function(a,b){g={},d(g,b,"id"),e(g,b,"name"),f(g,b.dataCollectionEvents,c),jQuery.isEmptyObject(g)||(g.color="#"+Math.floor(16777215*Math.random()).toString(16),h.push({population:g}))}),h}}a.MicaTimeline=function(){},a.MicaTimeline.prototype={create:function(c,d){var e=b(d);if(null!==e){var f=a(c).width(),g=d3.timeline().startYear(e.start).beginning(e.min).ending(e.max).width(f).stack().tickFormat({format:d3.format("d"),tickTime:1,tickNumber:1,tickSize:10}).margin({left:15,right:15,top:0,bottom:20}).rotateTicks(e.max>this.maxMonths?45:0).click(function(b){a("#event-"+b.id).modal()});d3.select(c).append("svg").attr("width",f).datum(e.data).call(g)}}},a.MicaTimeline.defaultOptions={maxMonths:300}}(jQuery);